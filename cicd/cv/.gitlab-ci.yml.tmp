---
stages:
  - run_cv
  - check_cv

.execute_cv_template:
  stage: run_cv
  tags:
    - tseethon-apptainer
  variables:
    GIT_STRATEGY: clone
  script:
    # parallel version
    - export CMSSW_release=$CMSSW_release
    # fixed vars
    - export CRABClient_version=prod
    - export CRABServer_tag=HEAD
    - export REST_Instance=test12
    - export Client_Validation_Suite=true
    # it should not need in future
    - export Repo_GH_Issue=novicecpp/CRABServer
    - export Repo_Testing_Scripts=novicecpp/CRABServer
    - export Branch_Testing_Scripts=wmcore_pypi
    - export Test_Docker_Image=registry.cern.ch/cmscrab/crabtesting:231009
    - bash -x cicd/gitlab/execute_test.sh
  cache:
    - key: ${CI_PIPELINE_ID}_${CMSSW_release}
      paths:
        - artifacts/submitted_tasks_CV_$CMSSW_release
      policy: push

.check_cv_template:
  stage: check_cv
  tags:
    - tseethon-apptainer
  variables:
    GIT_STRATEGY: clone
  script:
    # parallel version
    - export CMSSW_release=$CMSSW_release
    - export CRABClient_version=prod
    - export REST_Instance=test12
    - bash -x cicd/gitlab/check_clientValidation.sh
  cache:
    - key: ${CI_PIPELINE_ID}_${CMSSW_release}
      paths:
        - artifacts/submitted_tasks_CV_$CMSSW_release
      policy: pull


.execute_cv:
  extends: ".execute_cv_template"
  allow_failure: true
  variables:
    CMSSW_release: "<placeholder>"


.check_cv:
  extends: .check_cv_template
  variables:
    CMSSW_release: "<placeholder>"
    SCRAM_ARCH: "<placeholder>"
    singularity: "<placeholder>"
